AWSTemplateFormatVersion: '2010-09-09'
Resources:
  # create InstanceProfile wrapper on NodeRole
  KarpenterNodeInstanceProfile:
    Type: "AWS::IAM::InstanceProfile"
    Properties:
      InstanceProfileName: "KarpenterNodeInstanceProfile"
      Path: "/"
      Roles:
        - Ref: "KarpenterNodeRole"
  # create role with basic permissions for EKS node
  KarpenterNodeRole:
    Type: "AWS::IAM::Role"
    Properties:
      RoleName: "KarpenterNodeRole"
      Path: /
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
                !Sub "ec2.${AWS::URLSuffix}"
            Action:
              - "sts:AssumeRole"
      ManagedPolicyArns:
        - !Sub "arn:${AWS::Partition}:iam::aws:policy/AmazonEKSWorkerNodePolicy"
        - !Sub "arn:${AWS::Partition}:iam::aws:policy/AmazonEKS_CNI_Policy"
        - !Sub "arn:${AWS::Partition}:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly"
        - !Sub "arn:${AWS::Partition}:iam::aws:policy/AmazonSSMManagedInstanceCore"
  MyLaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateData:
        KeyName: delete-after-test-nonprod
        IamInstanceProfile:
          # Get ARN of InstanceProfile defined above
          Arn: !GetAtt
            - KarpenterNodeInstanceProfile
            - Arn
        ImageId: ami-0194c8e3f6dd95767
        UserData: "IyEvYmluL2Jhc2gKc2V0IC1leApDTFVTVEVSX05BTUU9J2thcnBlbnRlci1ub25wcm9kJwpBUElfU0VSVkVSX1VSTD1odHRwczovLzdCMTZEQkQ1MUYwQTFDMjhBQjc0RTJFMEEyRDA4RjZELmdyNy51cy1lYXN0LTEuZWtzLmFtYXpvbmF3cy5jb20KQjY0X0NMVVNURVJfQ0E9TFMwdExTMUNSVWRKVGlCRFJWSlVTVVpKUTBGVVJTMHRMUzB0Q2sxSlNVTTFla05EUVdNclowRjNTVUpCWjBsQ1FVUkJUa0puYTNGb2EybEhPWGN3UWtGUmMwWkJSRUZXVFZKTmQwVlJXVVJXVVZGRVJYZHdjbVJYU213S1kyMDFiR1JIVm5wTlFqUllSRlJKZUUxVVNYbE9SRUUwVFZSRmVVMUdiMWhFVkUxNFRWUkplVTFxUVRSTlZFVjVUVVp2ZDBaVVJWUk5Ra1ZIUVRGVlJRcEJlRTFMWVROV2FWcFlTblZhV0ZKc1kzcERRMEZUU1hkRVVWbEtTMjlhU1doMlkwNUJVVVZDUWxGQlJHZG5SVkJCUkVORFFWRnZRMmRuUlVKQlRFVmhDbTR2YWs1Q2RXaEhVVmc1Wkd0VVNXRm5ZV1UwU0c5Q1RYbG5UWEpvTjBOd1FWbHZOMjVwSzB4bWJIZGlVSG8zVTIxRFkxa3ljR2x0VTNwSk5tNTZiMjhLVG5GekwwSkNTbXhwVFVsamRHSldTVXBzVlhGT2RteFVVMGRMVmtsNWJWRjZaSFJ4SzJGek5IcG1VVlJMWVdSMlVWQlNkbGhpUmpCTVdrb3lNR1pGTkFwQ1ZsRlJSa3hQTTNkYWEyVTVVMlpaTUdKeVRpdHVZazVMTDJaQmRGSlhOMk5QVldsRWIwbHZSek5NZW5Wa1N6VkRjVVp3ZGtSWGNHOUxZekl4ZURkbkNqZHJVM2d3U2psWk1uaDFaRlJTUVd0dlVsUXphakpoZEcxQ2RGQndhWFpKWm5Cek1VMXVkMnRKYVZkUGF6bDJWSE5oZDFwaVdUa3JUUzlYTlRjMlFra0tUelJMWkVWWmFHSkRObUpuYzFSeU0zTjVZM2t6YjBnd2FtZEliSGxYWm5oVFpuWjBTMVp2VGpaQ1owUkJjVm8wUXpCTk0zcGtSMVlyTlVkQ2JHTkVOQXAxYzJkeFdYcFRlRGxvUWxwU2VVNTNUVFE0UTBGM1JVRkJZVTVEVFVWQmQwUm5XVVJXVWpCUVFWRklMMEpCVVVSQlowdHJUVUU0UjBFeFZXUkZkMFZDQ2k5M1VVWk5RVTFDUVdZNGQwaFJXVVJXVWpCUFFrSlpSVVpEVWxaNFFqTXJjWEJYYmk5MWNtVXpiV1kyZWxkTU1qRnZXa3ROUVRCSFExTnhSMU5KWWpNS1JGRkZRa04zVlVGQk5FbENRVkZEWlZOdWVERnFjR3BGY1hKTVMwVnlWVFZOVlRCdmExbFBTWEY1VlU4NGVqWnRLM0J0UW5oSVVWTlpNR3BYY21OU0t3cG5NRUU0TldsalQxRlNhakZYV2tOUVRrVkljRkpJTjNKc1RpdEdMMEZYVUcwd09XeHJjVXh2UzBFck4yWjFSRWQ2Vnk4eVpIUklZMUZTWm0xcmVuTjRDa1l4UTBKR1JFbFBORlZzZW5CWmF5dHBRbkZvVGtWaE1FWnNPVmxxWW5sb1JtNUJUVlpqT1VWbVpuaHpiVWdyY1RsUGNYa3ZjV0ppUzJKeE5HeERhRWdLVDBKaFpsUkNaV0YxVTFwSlJUaElUbVJ1WldsWE1rZFZjemNyVkRBMlR6ZGhSV1pvT1ZoUFdERklXbVZxYUhGclR6SjVRamt5SzJKQlQzRkhiRTVqVmdvelpVNDJReXQwWm1kbFNHbDNTbmx1YVVwbmVXRXZWekJDU0hGdFZUUjBiRWRYVDBwMFNteHZVMHBOY0cxbE9YQndUMEl3WTNObldIWk5Va1JXUjJKa0NqTTJlR2hyZWxoMGVGSnRRMVJRWWs5R1VYRllMemRVZGpkV0wySTJSMFZyVlV4eFlRb3RMUzB0TFVWT1JDQkRSVkpVU1VaSlEwRlVSUzB0TFMwdENnPT0KS1VCRUxFVF9FWFRSQV9BUkdTPSctLW5vZGUtbGFiZWxzPW5vZGUuazhzLmF3cy9jYXBhY2l0eS10eXBlPXNwb3QnCi9ldGMvZWtzL2Jvb3RzdHJhcC5zaCAkQ0xVU1RFUl9OQU1FIC0ta3ViZWxldC1leHRyYS1hcmdzICRLVUJFTEVUX0VYVFJBX0FSR1MgLS1iNjQtY2x1c3Rlci1jYSAkQjY0X0NMVVNURVJfQ0EgLS1hcGlzZXJ2ZXItZW5kcG9pbnQgJEFQSV9TRVJWRVJfVVJMIA=="
        BlockDeviceMappings:
          - Ebs:
              VolumeSize: 120
              VolumeType: gp3
            DeviceName: /dev/xvda
        # The SecurityGroup must be associated with the cluster VPC
        SecurityGroupIds:
          - sg-080912d725245e846 
      LaunchTemplateName: KarpenterCustomLaunchTemplate